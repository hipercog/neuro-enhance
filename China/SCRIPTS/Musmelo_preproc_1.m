%% PATHS
% raw_data_path = 'G:\Data_from_China\music_group\melody_paradigm\1-group\'; 
% cd(raw_data_path);
% output_path ='G:\Data_from_China\music_group\melody_paradigm\1-group\preproc\'; 
% bin_descript_path = 'G:\Data_from_China\scripts_and_plugin\';

proj_root = '~/Benslab/PROJECT_NEUROENHANCE/China';
data_dir = 'CHINA_PRETESTS';
group_dir = 'control';
para_dir = 'multiMMN';
ind = fullfile(proj_root, data_dir, group_dir, para_dir);
output_path = fullfile(proj_root, 'ANALYSIS', group_dir, para_dir);
if ~isdir(output_path), mkdir(output_path); end
% trl_csv = fullfile(proj_root, 'SCRIPTS', 'musmelo_trial_indices');
trl_csv = fullfile(fileparts(mfilename('fullpath')), 'musmelo_trial_indices');

files = dir(fullfile(ind, '*.raw'));
files = {files.name};

%% TRIAL INDICES
%Melody
melody_standardTrials = csvread(fullfile(trl_csv, 'melody_std.csv'));
% melody_stdTrls = [9,11,142,154,166,196,221,232,256,279,281,412,424,436 ...
%     ,466,491,502,526,549,551,682,694,706,736,761,772,796,819,821,952,964,976 ...
%     ,1006,1031,1042,1066,1089,1091,1222,1234,1246,1276,1301,1312,1336,1359 ...
%     ,1361,1492,1504,1516,1546,1571,1582,1606,1629,1631,1762,1774,1786,1816 ...
%     ,1841,1852,1876,1899,1901,2032,2044,2056,2086,2111,2122,2146];
%standard trials for the melody deviant + the extra trigger at beginning of file
%melody_standardTrials = melody_standardTrials+1;
%melody_deviant = 6+65280; %melody deviant trigger = 6
melody_deviant = 6;

%Timbre: note that there are also trial numbers for one of the deviant triggers
timbre_standardTrials = csvread(fullfile(trl_csv, 'timbre_std.csv'));
% timbre_stdTrls = [9 11 15 17 18 50 62 68 74 78 80 84 90 92 96 98 102 ...
%     104 114 116 122 128 132 134 138 140 142 146 150 154 156 158 162 164 166 ...
%     170 174 176 180 182 184 188 196 198 200 202 206 210 221 228 232 238 250 ...
%     252 256 262 279 281 285 287 288 320 332 338 344 348 350 354 360 362 366 ...
%     368 372 374 384 386 392 398 402 404 408 410 412 416 420 424 426 428 432 ...
%     434 436 440 444 446 450 452 454 458 466 468 470 472 476 480 491 498 502 ...
%     508 520 522 526 532 549 551 555 557 558 590 602 608 614 618 620 624 630 ...
%     632 636 638 642 644 654 656 662 668 672 674 678 680 682 686 690 694 696 ...
%     698 702 704 706 710 714 716 720 722 724 728 736 738 740 742 746 750 761 ...
%     768 772 778 790 792 796 802 819 821 825 827 828 860 872 878 884 888 890 ...
%     894 900 902 906 908 912 914 924 926 932 938 942 944 948 950 952 956 960 ...
%     964 966 968 972 974 976 980 984 986 990 992 994 998 1006 1008 1010 1012 ...
%     1016 1020 1031 1038 1042 1048 1060 1062 1066 1072 1089 1091 1095 1097 ...
%     1098 1130 1142 1148 1154 1158 1160 1164 1170 1172 1176 1178 1182 1184 ...
%     1194 1196 1202 1208 1212 1214 1218 1220 1222 1226 1230 1234 1236 1238 ...
%     1242 1244 1246 1250 1254 1256 1260 1262 1264 1268 1276 1278 1280 1282 ...
%     1286 1290 1301 1308 1312 1318 1330 1332 1336 1342 1359 1361 1365 1367 ...
%     1368 1400 1412 1418 1424 1428 1430 1434 1440 1442 1446 1448 1452 1454 ...
%     1464 1466 1472 1478 1482 1484 1488 1490 1492 1496 1500 1504 1506 1508 ...
%     1512 1514 1516 1520 1524 1526 1530 1532 1534 1538 1546 1548 1550 1552 ...
%     1556 1560 1571 1578 1582 1588 1600 1602 1606 1612 1629 1631 1635 1637 ...
%     1638 1670 1682 1688 1694 1698 1700 1704 1710 1712 1716 1718 1722 1724 ...
%     1734 1736 1742 1748 1752 1754 1758 1760 1762 1766 1770 1774 1776 1778 ...
%     1782 1784 1786 1790 1794 1796 1800 1802 1804 1808 1816 1818 1820 1822 ...
%     1826 1830 1841 1848 1852 1858 1870 1872 1876 1882 1899 1901 1905 1907 ...
%     1908 1940 1952 1958 1964 1968 1970 1974 1980 1982 1986 1988 1992 1994 ...
%     2004 2006 2012 2018 2022 2024 2028 2030 2032 2036 2040 2044 2046 2048 ...
%     2052 2054 2056 2060 2064 2066 2070 2072 2074 2078 2086 2088 2090 2092 ...
%     2096 2100 2111 2118 2122 2128 2140 2142 2146 2152];
%timbre_standardTrials = timbre_standardTrials+1;
timbre_deviantTrials = csvread(fullfile(trl_csv, 'timbre_dev.csv'));
% timbre_devTrls = [36 54 72 192 240 264 306 324 342 462 510 534 576 594 ...
%     612 732 780 804 846 864 882 1002 1050 1074 1116 1134 1152 1272 1320 1344 ...
%     1386 1404 1422 1542 1590 1614 1656 1674 1692 1812 1860 1884 1926 1944 ...
%     1962 2082 2130 2154];
%timbre_deviantTrials = timbre_deviantTrials+1;
%timbre_deviant = 8+65280;
timbre_deviant = 8;

%Rhythm
rhythm_standardTrials = csvread(fullfile(trl_csv, 'rhythm_std.csv'));
% rhythm_stdTrls = [9,10,16,116,134,141,142,154,165,166,182,183,196,200 ...
%     ,201,220,227,231,236,237,251,255,260,261,279,280,286,386,404,411,412,424 ...
%     ,435,436,452,453,466,470,471,490,497,501,506,507,521,525,530,531,549,550 ...
%     ,556,656,674,681,682,694,705,706,722,723,736,740,741,760,767,771,776,777 ...
%     ,791,795,800,801,819,820,826,926,944,951,952,964,975,976,992,993,1006 ...
%     ,1010,1011,1030,1037,1041,1046,1047,1061,1065,1070,1071,1089,1090,1096 ...
%     ,1196,1214,1221,1222,1234,1245,1246,1262,1263,1276,1280,1281,1300,1307 ...
%     ,1311,1316,1317,1331,1335,1340,1341,1359,1360,1366,1466,1484,1491,1492 ...
%     ,1504,1515,1516,1532,1533,1546,1550,1551,1570,1577,1581,1586,1587,1601 ...
%     ,1605,1610,1611,1629,1630,1636,1736,1754,1761,1762,1774,1785,1786,1802 ...
%     ,1803,1816,1820,1821,1840,1847,1851,1856,1857,1871,1875,1880,1881,1899 ...
%     ,1900,1906,2006,2024,2031,2032,2044,2055,2056,2072,2073,2086,2090,2091 ...
%     ,2110,2117,2121,2126,2127,2141,2145,2150,2151];
%rhythm_standardTrials = rhythm_standardTrials+1;
%rhythm_deviant = [10+65280, 101+65280]; 
rhythm_deviant = [10, 101];

%Mistuning
mistune_standardTrials = csvread(fullfile(trl_csv, 'mistune_std.csv'));
% mistune_stdTrls = [9,11,50,62,68,74,80,92,98,104,122,128,140,142,146 ...
%     ,154,158,164,166,170,176,188,196,206,221,227,232,251,256,279,281,320,332 ...
%     ,338,344,350,362,368,374,392,398,410,412,416,424,428,434,436,440,446,458 ...
%     ,466,476,491,497,502,521,526,549,551,590,602,608,614,620,632,638,644,662 ...
%     ,668,680,682,686,694,698,704,706,710,716,728,736,746,761,767,772,791,796 ...
%     ,819,821,860,872,878,884,890,902,908,914,932,938,950,952,956,964,968,974 ...
%     ,976,980,986,998,1006,1016,1031,1037,1042,1061,1066,1089,1091,1130,1142 ...
%     ,1148,1154,1160,1172,1178,1184,1202,1208,1220,1222,1226,1234,1238,1244 ...
%     ,1246,1250,1256,1268,1276,1286,1301,1307,1312,1331,1336,1359,1361,1400 ...
%     ,1412,1418,1424,1430,1442,1448,1454,1472,1478,1490,1492,1496,1504,1508 ...
%     ,1514,1516,1520,1526,1538,1546,1556,1571,1577,1582,1601,1606,1629,1631 ...
%     ,1670,1682,1688,1694,1700,1712,1718,1724,1742,1748,1760,1762,1766,1774 ...
%     ,1778,1784,1786,1790,1796,1808,1816,1826,1841,1847,1852,1871,1876,1899 ...
%     ,1901,1940,1952,1958,1964,1970,1982,1988,1994,2012,2018,2030,2032,2036 ...
%     ,2044,2048,2054,2056,2060,2066,2078,2086,2096,2111,2117,2122,2141,2146];
%mistune_standardTrials = mistune_standardTrials+1;
%mistune_deviant = 7+65280;
mistune_deviant = 7;

%Transposition
%transpos_standard = 1+65280;
%transpos_deviant = 5+65280;
transpos_standard = 1;
transpos_deviant = 5;


%% PROCESSING
%This is a for loop that contains commands for filtering and epoching the raw 
% data and for saving the processed file 
for i = 1:length(files)
     %This command loads the data to eeglab

    EEG = pop_readegi(fullfile(ind, files{i}), [],[], 'auto');
    % load channel location file
    EEG = pop_chanedit(EEG, 'load'...
        , {fullfile(proj_root, 'EGI_chanlocs', '2_9AverageNet128_v1.sfp')...
        'filetype' 'sfp'});
    EEG = eeg_checkset( EEG );    
    
    % Reduce the sampling rate to 500 Hz
    EEG = pop_resample(EEG, 500);
    %setting the reference channels (mastoids)
    EEG = pop_reref(EEG, [57 100] ,'keepref', 'off');
% pop_eegfiltnew(EEG, locutoff, hicutoff, filtorder, revfilt, usefft, plotfreqz, minphase);
    %high-pass filtering
    EEG = pop_eegfiltnew(EEG, [], 0.5, 3380, 1, [], 1);
    %low-pass filtering
    EEG = pop_eegfiltnew(EEG, [], 30, 226, 0, [], 1);
    % changing non-numeric event codes to numeric ones 
    %(otherwise erp-lab doesn't work)
    EEG = letterkilla(EEG);

    %Adding new event codes

    evlat = {EEG.event.latency}; %latencies of the original events

    %Five classes of event latencies where we want to add triggers
    melody_binevlat = evlat(melody_standardTrials); 
    timbre_sd_binevlat = evlat(timbre_standardTrials);
    timbre_dev_binevlat = evlat(timbre_deviantTrials);
    rhythm_binevlat = evlat(rhythm_standardTrials);
    mistune_binevlat = evlat(mistune_standardTrials);

    
    % Below, change trigger type to match your trigger codes
    
    %Melody
    for a = 1:length(melody_binevlat)
        n_ev = length(EEG.event); %number of triggers in the original file
        EEG.event(n_ev+1).type = '11'; %add extra event
        EEG.event(n_ev+1).urevent = n_ev+1; %the urevent thingy of the new event
        EEG.event(n_ev+1).latency = melody_binevlat{a}; %set new event latency
    end

    %Timbre standard
    for a = 1:length(timbre_sd_binevlat)
        n_ev = length(EEG.event); %number of triggers in the original file
        EEG.event(n_ev+1).type = '222'; %add an extra event
        EEG.event(n_ev+1).urevent = n_ev+1; %the urevent thingy of the new event
        EEG.event(n_ev+1).latency = timbre_sd_binevlat{a};%set new event latency
    end

    %Timbre deviant
    for a = 1:length(timbre_dev_binevlat)
        n_ev = length(EEG.event); %number of triggers in the original file
        EEG.event(n_ev+1).type = '88'; %add an extra event
        EEG.event(n_ev+1).urevent = n_ev+1; %the urevent thingy of the new event
        EEG.event(n_ev+1).latency = timbre_dev_binevlat{a};%set new event latency
    end
    
    %Rhythm
    for a = 1:length(rhythm_binevlat)
        n_ev = length(EEG.event); %number of triggers in the original file
        EEG.event(n_ev+1).type = '33'; %add an extra event
        EEG.event(n_ev+1).urevent = n_ev+1; %the urevent thingy of the new event
        EEG.event(n_ev+1).latency = rhythm_binevlat{a};%set new event latency
    end
    
    %Mistune
    for a = 1:length(mistune_binevlat)
        n_ev = length(EEG.event); %number of triggers in the original file
        EEG.event(n_ev+1).type = '44'; %add an extra event
        EEG.event(n_ev+1).urevent = n_ev+1; %the urevent thingy of the new event
        EEG.event(n_ev+1).latency = mistune_binevlat{a};%set new event latency
    end

    %Edit event list parameter AlphanumericCleaning is done by letterkilla.m
    EEG  = pop_editeventlist(EEG...
        , 'BoundaryNumeric', {-99}...
        , 'BoundaryString', { 'boundary' }...
        , 'List', fullfile(proj_root, 'ANALYSIS', 'ERPLab', 'musmelo_eventlist.txt')...
        , 'SendEL2', 'EEG'...
        , 'UpdateEEG', 'codelabel'...
        , 'Warning', 'off' );
%         , 'AlphanumericCleaning', 'on'...
    disp(EEG.event(1,1));
    
    EEG = pop_binlister(EEG, 'BDF'...
        , fullfile(proj_root, 'ANALYSIS', 'ERPLab', 'musmelo_bindescript.txt'));
    disp(EEG.event(1,1));
    
    %extract binbased epochs using ERPlab - -50-350ms
    EEG = pop_epochbin( EEG , [-50.0  350.0],  'pre');
    %baseline correction
    EEG = pop_rmbase( EEG, [-50.7812  0]);
    disp(EEG.event(1,1));
    
    %saving the data to the output folder
    [p, n, e] = fileparts(files{i});
    EEG = pop_saveset( EEG...
        , 'filename', [n '.set']...
        , 'filepath', output_path);
end
